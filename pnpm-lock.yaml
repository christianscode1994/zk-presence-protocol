# 1. Remove the broken lockfile from the repo and workspace file if you accidentally committed heredoc text into them
git rm pnpm-lock.yaml || true

# 2. Ensure a valid pnpm-workspace.yaml exists at repo root with exactly:
cat > pnpm-workspace.yaml <<'YAML'
packages:
  - "apps/*"
YAML

# 3. Ensure a simple .npmrc (optional but recommended)
cat > .npmrc <<'NPMRC'
registry=https://registry.npmjs.org/
fetch-retries=2
fetch-retry-factor=1
strict-ssl=true
NPMRC

# 4. Install pnpm and regenerate a fresh, valid lockfile
npm i -g pnpm@8
pnpm install

# 5. Verify the generated lockfile looks sane (optional quick check)
head -n 40 pnpm-lock.yaml

# 6. Commit and push the corrected files
git add pnpm-workspace.yaml .npmrc pnpm-lock.yaml
git commit -m "Regenerate pnpm-lock.yaml; add pnpm-workspace and .npmrc"
git push origin $(git branch --show-current)
